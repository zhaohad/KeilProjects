C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DRV_RF24L01
OBJECT MODULE PLACED IN ..\output\drv_RF24L01.obj
COMPILER INVOKED BY: d:\Keil_v5\C51\BIN\C51.EXE Source_File\drv_periph\src\drv_RF24L01.c COMPACT OPTIMIZE(8,SPEED) BROWS
                    -E INCDIR(.\Source_File\app\inc;.\Source_File\drv_mcu\inc;.\Source_File\drv_periph\inc) DEBUG OBJECTEXTEND PRINT(..\outpu
                    -t\drv_RF24L01.lst) TABS(2) OBJECT(..\output\drv_RF24L01.obj)

line level    source

   1          #include "drv_RF24L01.h"
   2          #include "drv_delay.h"
   3          
   4          
   5          const char *g_ErrorString = "RF24L01 is not find !...";
   6          
   7          
   8          /**
   9            * @brief :NRF24L01è¯»å¯„å­˜å™¨
  10            * @param :
  11                     @Addr:å¯„å­˜å™¨åœ°å€
  12            * @note  :åœ°å€åœ¨è®¾å¤‡ä¸­æœ‰æ•ˆ
  13            * @retval:è¯»å–çš„æ•°æ®
  14            */
  15          uint8_t NRF24L01_Read_Reg( uint8_t RegAddr )
  16          {
  17   1          uint8_t btmp;
  18   1        
  19   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
  20   1        
  21   1          drv_spi_read_write_byte( NRF_READ_REG | RegAddr );  //è¯»å‘½ä»¤ åœ°å€
  22   1          btmp = drv_spi_read_write_byte( 0xFF );       //è¯»æ•°æ®
  23   1        
  24   1          RF24L01_SET_CS_HIGH( );     //å–æ¶ˆç‰‡é€‰
  25   1        
  26   1          return btmp;
  27   1      }
  28          
  29          /**
  30            * @brief :NRF24L01è¯»æŒ‡å®šé•¿åº¦çš„æ•°æ®
  31            * @param :
  32            *     @reg:åœ°å€
  33            *     @pBuf:æ•°æ®å­˜æ”¾åœ°å€
  34            *     @len:æ•°æ®é•¿åº¦
  35            * @note  :æ•°æ®é•¿åº¦ä¸è¶…è¿‡255ï¼Œåœ°å€åœ¨è®¾å¤‡ä¸­æœ‰æ•ˆ
  36            * @retval:è¯»å–çŠ¶æ€
  37            */
  38          void NRF24L01_Read_Buf( uint8_t RegAddr, uint8_t *pBuf, uint8_t len )
  39          {
  40   1          uint8_t btmp;
  41   1        
  42   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
  43   1        
  44   1          drv_spi_read_write_byte( NRF_READ_REG | RegAddr );  //è¯»å‘½ä»¤ åœ°å€
  45   1          for( btmp = 0; btmp < len; btmp ++ )
  46   1          {
  47   2              *( pBuf + btmp ) = drv_spi_read_write_byte( 0xFF ); //è¯»æ•°æ®
  48   2          }
  49   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
  50   1      }
  51          
  52          /**
  53            * @brief :NRF24L01å†™å¯„å­˜å™¨
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 2   

  54            * @param :æ— 
  55            * @note  :åœ°å€åœ¨è®¾å¤‡ä¸­æœ‰æ•ˆ
  56            * @retval:è¯»å†™çŠ¶æ€
  57            */
  58          void NRF24L01_Write_Reg( uint8_t RegAddr, uint8_t Value )
  59          {
  60   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
  61   1        
  62   1          drv_spi_read_write_byte( NRF_WRITE_REG | RegAddr ); //å†™å‘½ä»¤ åœ°å€
  63   1          drv_spi_read_write_byte( Value );     //å†™æ•°æ®
  64   1        
  65   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
  66   1      }
  67          
  68          /**
  69            * @brief :NRF24L01å†™æŒ‡å®šé•¿åº¦çš„æ•°æ®
  70            * @param :
  71            *     @reg:åœ°å€
  72            *     @pBuf:å†™å…¥çš„æ•°æ®åœ°å€
  73            *     @len:æ•°æ®é•¿åº¦
  74            * @note  :æ•°æ®é•¿åº¦ä¸è¶…è¿‡255ï¼Œåœ°å€åœ¨è®¾å¤‡ä¸­æœ‰æ•ˆ
  75            * @retval:å†™çŠ¶æ€
  76            */
  77          void NRF24L01_Write_Buf( uint8_t RegAddr, uint8_t *pBuf, uint8_t len )
  78          {
  79   1          uint8_t i;
  80   1        
  81   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
  82   1        
  83   1          drv_spi_read_write_byte( NRF_WRITE_REG | RegAddr ); //å†™å‘½ä»¤ åœ°å€
  84   1          for( i = 0; i < len; i ++ )
  85   1          {
  86   2              drv_spi_read_write_byte( *( pBuf + i ) );   //å†™æ•°æ®
  87   2          }
  88   1        
  89   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
  90   1      }
  91          
  92          /**
  93            * @brief :æ¸…ç©ºTXç¼“å†²åŒº
  94            * @param :æ— 
  95            * @note  :æ— 
  96            * @retval:æ— 
  97            */
  98          void NRF24L01_Flush_Tx_Fifo ( void )
  99          {
 100   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 101   1        
 102   1          drv_spi_read_write_byte( FLUSH_TX );  //æ¸…TX FIFOå‘½ä»¤
 103   1        
 104   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 105   1      }
 106          
 107          /**
 108            * @brief :æ¸…ç©ºRXç¼“å†²åŒº
 109            * @param :æ— 
 110            * @note  :æ— 
 111            * @retval:æ— 
 112            */
 113          void NRF24L01_Flush_Rx_Fifo( void )
 114          {
 115   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 3   

 116   1        
 117   1          drv_spi_read_write_byte( FLUSH_RX );  //æ¸…RX FIFOå‘½ä»¤
 118   1        
 119   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 120   1      }
 121          
 122          /**
 123            * @brief :é‡æ–°ä½¿ç”¨ä¸Šä¸€åŒ…æ•°æ®
 124            * @param :æ— 
 125            * @note  :æ— 
 126            * @retval:æ— 
 127            */
 128          void NRF24L01_Reuse_Tx_Payload( void )
 129          {
 130   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 131   1        
 132   1          drv_spi_read_write_byte( REUSE_TX_PL );   //é‡æ–°ä½¿ç”¨ä¸Šä¸€åŒ…å‘½ä»¤
 133   1        
 134   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 135   1      }
 136          
 137          /**
 138            * @brief :NRF24L01ç©ºæ“ä½œ
 139            * @param :æ— 
 140            * @note  :æ— 
 141            * @retval:æ— 
 142            */
 143          void NRF24L01_Nop( void )
 144          {
 145   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 146   1        
 147   1          drv_spi_read_write_byte( NOP );   //ç©ºæ“ä½œå‘½ä»¤
 148   1        
 149   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 150   1      }
 151          
 152          /**
 153            * @brief :NRF24L01è¯»çŠ¶æ€å¯„å­˜å™¨
 154            * @param :æ— 
 155            * @note  :æ— 
 156            * @retval:RF24L01çŠ¶æ€
 157            */
 158          uint8_t NRF24L01_Read_Status_Register( void )
 159          {
 160   1          uint8_t Status;
 161   1        
 162   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 163   1        
 164   1          Status = drv_spi_read_write_byte( NRF_READ_REG + STATUS );  //è¯»çŠ¶æ€å¯„å­˜å™¨
 165   1        
 166   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 167   1        
 168   1          return Status;
 169   1      }
 170          
 171          /**
 172            * @brief :NRF24L01æ¸…ä¸­æ–­
 173            * @param :
 174                     @IRQ_Source:ä¸­æ–­æº
 175            * @note  :æ— 
 176            * @retval:æ¸…é™¤åçŠ¶æ€å¯„å­˜å™¨çš„å€¼
 177            */
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 4   

 178          uint8_t NRF24L01_Clear_IRQ_Flag( uint8_t IRQ_Source )
 179          {
 180   1          uint8_t btmp = 0;
 181   1      
 182   1          IRQ_Source &= ( 1 << RX_DR ) | ( 1 << TX_DS ) | ( 1 << MAX_RT );  //ä¸­æ–­æ ‡å¿—å¤„ç†
 183   1          btmp = NRF24L01_Read_Status_Register( );      //è¯»çŠ¶æ€å¯„å­˜å™¨
 184   1            
 185   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
 186   1          drv_spi_read_write_byte( NRF_WRITE_REG + STATUS );  //å†™çŠ¶æ€å¯„å­˜å™¨å‘½ä»¤
 187   1          drv_spi_read_write_byte( IRQ_Source | btmp );   //æ¸…ç›¸åº”ä¸­æ–­æ ‡å¿—
 188   1          RF24L01_SET_CS_HIGH( );     //å–æ¶ˆç‰‡é€‰
 189   1        
 190   1          return ( NRF24L01_Read_Status_Register( ));     //è¿”å›çŠ¶æ€å¯„å­˜å™¨çŠ¶æ€
 191   1      }
 192          
 193          /**
 194            * @brief :è¯»RF24L01ä¸­æ–­çŠ¶æ€
 195            * @param :æ— 
 196            * @note  :æ— 
 197            * @retval:ä¸­æ–­çŠ¶æ€
 198            */
 199          uint8_t RF24L01_Read_IRQ_Status( void )
 200          {
 201   1          return ( NRF24L01_Read_Status_Register( ) & (( 1 << RX_DR ) | ( 1 << TX_DS ) | ( 1 << MAX_RT ))); //è¿
             -”å›ä¸­æ–­çŠ¶æ€
 202   1      }
 203           
 204           /**
 205            * @brief :è¯»FIFOä¸­æ•°æ®å®½åº¦
 206            * @param :æ— 
 207            * @note  :æ— 
 208            * @retval:æ•°æ®å®½åº¦
 209            */
 210          uint8_t NRF24L01_Read_Top_Fifo_Width( void )
 211          {
 212   1          uint8_t btmp;
 213   1        
 214   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 215   1        
 216   1          drv_spi_read_write_byte( R_RX_PL_WID ); //è¯»FIFOä¸­æ•°æ®å®½åº¦å‘½ä»¤
 217   1          btmp = drv_spi_read_write_byte( 0xFF ); //è¯»æ•°æ®
 218   1        
 219   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 220   1        
 221   1          return btmp;
 222   1      }
 223          
 224           /**
 225            * @brief :è¯»æ¥æ”¶åˆ°çš„æ•°æ®
 226            * @param :æ— 
 227            * @note  :æ— 
 228            * @retval:
 229                     @pRxBuf:æ•°æ®å­˜æ”¾åœ°å€é¦–åœ°å€
 230            */
 231          uint8_t NRF24L01_Read_Rx_Payload( uint8_t *pRxBuf )
 232          {
 233   1          uint8_t Width, PipeNum;
 234   1        
 235   1          PipeNum = ( NRF24L01_Read_Reg( STATUS ) >> 1 ) & 0x07;  //è¯»æ¥æ”¶çŠ¶æ€
 236   1          Width = NRF24L01_Read_Top_Fifo_Width( );    //è¯»æ¥æ”¶æ•°æ®ä¸ªæ•°
 237   1      
 238   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 5   

 239   1          drv_spi_read_write_byte( RD_RX_PLOAD );     //è¯»æœ‰æ•ˆæ•°æ®å‘½ä»¤
 240   1        
 241   1          for( PipeNum = 0; PipeNum < Width; PipeNum ++ )
 242   1          {
 243   2              *( pRxBuf + PipeNum ) = drv_spi_read_write_byte( 0xFF );    //è¯»æ•°æ®
 244   2          }
 245   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 246   1          NRF24L01_Flush_Rx_Fifo( );  //æ¸…ç©ºRX FIFO
 247   1        
 248   1          return Width;
 249   1      }
 250          
 251           /**
 252            * @brief :å‘é€æ•°æ®ï¼ˆå¸¦åº”ç­”ï¼‰
 253            * @param :
 254            *     @pTxBuf:å‘é€æ•°æ®åœ°å€
 255            *     @len:é•¿åº¦
 256            * @note  :ä¸€æ¬¡ä¸è¶…è¿‡32ä¸ªå­—èŠ‚
 257            * @retval:æ— 
 258            */
 259          void NRF24L01_Write_Tx_Payload_Ack( uint8_t *pTxBuf, uint8_t len )
 260          {
 261   1          uint8_t btmp;
 262   1          uint8_t length = ( len > 32 ) ? 32 : len;   //æ•°æ®é•¿è¾¾å¤§çº¦32 åˆ™åªå‘é€32ä¸ª
 263   1      
 264   1          NRF24L01_Flush_Tx_Fifo( );    //æ¸…TX FIFO
 265   1        
 266   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
 267   1          drv_spi_read_write_byte( WR_TX_PLOAD ); //å‘é€å‘½ä»¤
 268   1        
 269   1          for( btmp = 0; btmp < length; btmp ++ )
 270   1          {
 271   2              drv_spi_read_write_byte( *( pTxBuf + btmp ) );  //å‘é€æ•°æ®
 272   2          }
 273   1          RF24L01_SET_CS_HIGH( );     //å–æ¶ˆç‰‡é€‰
 274   1      }
 275          
 276           /**
 277            * @brief :å‘é€æ•°æ®ï¼ˆä¸å¸¦åº”ç­”ï¼‰
 278            * @param :
 279            *     @pTxBuf:å‘é€æ•°æ®åœ°å€
 280            *     @len:é•¿åº¦
 281            * @note  :ä¸€æ¬¡ä¸è¶…è¿‡32ä¸ªå­—èŠ‚
 282            * @retval:æ— 
 283            */
 284          void NRF24L01_Write_Tx_Payload_NoAck( uint8_t *pTxBuf, uint8_t len )
 285          {
 286   1          if( len > 32 || len == 0 )
 287   1          {
 288   2              return ;    //æ•°æ®é•¿åº¦å¤§äº32 æˆ–è€…ç­‰äº0 ä¸æ‰§è¡Œ
 289   2          }
 290   1        
 291   1          RF24L01_SET_CS_LOW( );  //ç‰‡é€‰
 292   1          drv_spi_read_write_byte( WR_TX_PLOAD_NACK );  //å‘é€å‘½ä»¤
 293   1          while( len-- )
 294   1          {
 295   2              drv_spi_read_write_byte( *pTxBuf );     //å‘é€æ•°æ®
 296   2          pTxBuf++;
 297   2          }
 298   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 299   1      }
 300          
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 6   

 301           /**
 302            * @brief :åœ¨æ¥æ”¶æ¨¡å¼ä¸‹å‘TX FIFOå†™æ•°æ®(å¸¦ACK)
 303            * @param :
 304            *     @pData:æ•°æ®åœ°å€
 305            *     @len:é•¿åº¦
 306            * @note  :ä¸€æ¬¡ä¸è¶…è¿‡32ä¸ªå­—èŠ‚
 307            * @retval:æ— 
 308            */
 309          void NRF24L01_Write_Tx_Payload_InAck( uint8_t *pData, uint8_t len )
 310          {
 311   1          uint8_t btmp;
 312   1        
 313   1        len = ( len > 32 ) ? 32 : len;    //æ•°æ®é•¿åº¦å¤§äº32ä¸ªåˆ™åªå†™32ä¸ªå­—èŠ‚
 314   1      
 315   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
 316   1          drv_spi_read_write_byte( W_ACK_PLOAD );   //å‘½ä»¤
 317   1          for( btmp = 0; btmp < len; btmp ++ )
 318   1          {
 319   2              drv_spi_read_write_byte( *( pData + btmp ) ); //å†™æ•°æ®
 320   2          }
 321   1          RF24L01_SET_CS_HIGH( );     //å–æ¶ˆç‰‡é€‰
 322   1      }
 323          
 324           /**
 325            * @brief :è®¾ç½®å‘é€åœ°å€
 326            * @param :
 327            *     @pAddr:åœ°å€å­˜æ”¾åœ°å€
 328            *     @len:é•¿åº¦
 329            * @note  :æ— 
 330            * @retval:æ— 
 331            */
 332          void NRF24L01_Set_TxAddr( uint8_t *pAddr, uint8_t len )
 333          {
 334   1        len = ( len > 5 ) ? 5 : len;          //åœ°å€ä¸èƒ½å¤§äº5ä¸ªå­—èŠ‚
 335   1          NRF24L01_Write_Buf( TX_ADDR, pAddr, len );  //å†™åœ°å€
 336   1      }
 337          
 338           /**
 339            * @brief :è®¾ç½®æ¥æ”¶é€šé“åœ°å€
 340            * @param :
 341            *     @PipeNum:é€šé“
 342            *     @pAddr:åœ°å€å­˜è‚¥ç€åœ°å€
 343            *     @Len:é•¿åº¦
 344            * @note  :é€šé“ä¸å¤§äº5 åœ°å€é•¿åº¦ä¸å¤§äº5ä¸ªå­—èŠ‚
 345            * @retval:æ— 
 346            */
 347          void NRF24L01_Set_RxAddr( uint8_t PipeNum, uint8_t *pAddr, uint8_t Len )
 348          {
 349   1          Len = ( Len > 5 ) ? 5 : Len;
 350   1          PipeNum = ( PipeNum > 5 ) ? 5 : PipeNum;    //é€šé“ä¸å¤§äº5 åœ°å€é•¿åº¦ä¸å¤§äº5ä¸ªå­—èŠ‚
 351   1      
 352   1          NRF24L01_Write_Buf( RX_ADDR_P0 + PipeNum, pAddr, Len ); //å†™å…¥åœ°å€
 353   1      }
 354          
 355           /**
 356            * @brief :è®¾ç½®é€šä¿¡é€Ÿåº¦
 357            * @param :
 358            *     @Speed:é€Ÿåº¦
 359            * @note  :æ— 
 360            * @retval:æ— 
 361            */
 362          void NRF24L01_Set_Speed( nRf24l01SpeedType Speed )
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 7   

 363          {
 364   1        uint8_t btmp = 0;
 365   1        
 366   1        btmp = NRF24L01_Read_Reg( RF_SETUP );
 367   1        btmp &= ~( ( 1<<5 ) | ( 1<<3 ) );
 368   1        
 369   1        if( Speed == SPEED_250K )   //250K
 370   1        {
 371   2          btmp |= ( 1<<5 );
 372   2        }
 373   1        else if( Speed == SPEED_1M )   //1M
 374   1        {
 375   2            btmp &= ~( ( 1<<5 ) | ( 1<<3 ) );
 376   2        }
 377   1        else if( Speed == SPEED_2M )   //2M
 378   1        {
 379   2          btmp |= ( 1<<3 );
 380   2        }
 381   1      
 382   1        NRF24L01_Write_Reg( RF_SETUP, btmp );
 383   1      }
 384          
 385           /**
 386            * @brief :è®¾ç½®åŠŸç‡
 387            * @param :
 388            *     @Speed:é€Ÿåº¦
 389            * @note  :æ— 
 390            * @retval:æ— 
 391            */
 392          void NRF24L01_Set_Power( nRf24l01PowerType Power )
 393          {
 394   1          uint8_t btmp;
 395   1        
 396   1        btmp = NRF24L01_Read_Reg( RF_SETUP ) & ~0x07;
 397   1          switch( Power )
 398   1          {
 399   2              case POWER_F18DBM:
 400   2                  btmp |= PWR_18DB;
 401   2                  break;
 402   2              case POWER_F12DBM:
 403   2                  btmp |= PWR_12DB;
 404   2                  break;
 405   2              case POWER_F6DBM:
 406   2                  btmp |= PWR_6DB;
 407   2                  break;
 408   2              case POWER_0DBM:
 409   2                  btmp |= PWR_0DB;
 410   2                  break;
 411   2              default:
 412   2                  break;
 413   2          }
 414   1          NRF24L01_Write_Reg( RF_SETUP, btmp );
 415   1      }
 416          
 417           /**
 418            * @brief :è®¾ç½®é¢‘ç‡
 419            * @param :
 420            *     @FreqPoint:é¢‘ç‡è®¾ç½®å‚æ•°
 421            * @note  :å€¼ä¸å¤§äº127
 422            * @retval:æ— 
 423            */
 424          void RF24LL01_Write_Hopping_Point( uint8_t FreqPoint )
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 8   

 425          {
 426   1          NRF24L01_Write_Reg(  RF_CH, FreqPoint & 0x7F );
 427   1      }
 428          
 429          /**
 430            * @brief :NRF24L01æ£€æµ‹
 431            * @param :æ— 
 432            * @note  :æ— 
 433            * @retval:æ— 
 434            */ 
 435          void  NRF24L01_check( void )
 436          {
 437   1        uint8_t i;
 438   1        uint8_t buf[5]={ 0XA5, 0XA5, 0XA5, 0XA5, 0XA5 };
 439   1        uint8_t read_buf[ 5 ] = { 0 };
 440   1         
 441   1        while( 1 )
 442   1        {
 443   2          NRF24L01_Write_Buf( TX_ADDR, buf, 5 );      //å†™å…¥5ä¸ªå­—èŠ‚çš„åœ°å€
 444   2          NRF24L01_Read_Buf( TX_ADDR, read_buf,5 );   //è¯»å‡ºå†™å…¥çš„åœ°å€  
 445   2          for( i = 0; i < 5; i++ )
 446   2          {
 447   3            if( buf[ i ] != read_buf[ i ] )
 448   3            {
 449   4              break;      //è¯»å‡ºçš„å€¼å’Œå†™å…¥çš„ç½®ä¸åŒ
 450   4            } 
 451   3          } 
 452   2          
 453   2          if( 5 == i )
 454   2          {
 455   3            break;        //è¯»å‡ºçš„å­—ç¬¦ä¸²ä¸å†™å…¥çš„å­—ç¬¦ä¸²ç›¸åŒï¼Œåˆ¤æ–­ä¸ºè®¾å¤‡å­˜åœ¨
 456   3          }
 457   2          else
 458   2          {
 459   3            drv_uart_tx_bytes( (uint8_t *)g_ErrorString, 26 );  //æ£€æµ‹ä¸åˆ°è®¾å¤‡ï¼Œè¾“å‡ºè­¦å‘Šä¿¡æ¯
 460   3          }
 461   2          drv_delay_ms( 500 );  //500MSæ£€æµ‹ä¸€æ¬¡
 462   2        }
 463   1      }
 464          
 465           /**
 466            * @brief :è®¾ç½®æ¨¡å¼
 467            * @param :
 468            *     @Mode:æ¨¡å¼å‘é€æ¨¡å¼æˆ–æ¥æ”¶æ¨¡å¼
 469            * @note  :æ— 
 470            * @retval:æ— 
 471            */
 472          void RF24L01_Set_Mode( nRf24l01ModeType Mode )
 473          {
 474   1          uint8_t controlreg = 0;
 475   1        controlreg = NRF24L01_Read_Reg( CONFIG );
 476   1        
 477   1          if( Mode == MODE_TX )       
 478   1        {
 479   2          controlreg &= ~( 1<< PRIM_RX );
 480   2        }
 481   1          else 
 482   1        {
 483   2          if( Mode == MODE_RX )  
 484   2          { 
 485   3            controlreg |= ( 1<< PRIM_RX ); 
 486   3          }
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 9   

 487   2        }
 488   1      
 489   1          NRF24L01_Write_Reg( CONFIG, controlreg );
 490   1      }
 491          
 492          /**
 493            * @brief :NRF24L01å‘é€ä¸€æ¬¡æ•°æ®
 494            * @param :
 495            *     @txbuf:å¾…å‘é€æ•°æ®é¦–åœ°å€
 496            *     @Length:å‘é€æ•°æ®é•¿åº¦
 497            * @note  :æ— 
 498            * @retval:
 499            *     MAX_TXï¼šè¾¾åˆ°æœ€å¤§é‡å‘æ¬¡æ•°
 500            *     TX_OKï¼šå‘é€å®Œæˆ
 501            *     0xFF:å…¶ä»–åŸå› 
 502            */ 
 503          uint8_t NRF24L01_TxPacket( uint8_t *txbuf, uint8_t Length )
 504          {
 505   1        uint8_t l_Status = 0;
 506   1        uint16_t l_MsTimes = 0;
 507   1        
 508   1        RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 509   1        drv_spi_read_write_byte( FLUSH_TX );
 510   1        RF24L01_SET_CS_HIGH( );
 511   1        
 512   1        RF24L01_SET_CE_LOW( );    
 513   1        NRF24L01_Write_Buf( WR_TX_PLOAD, txbuf, Length ); //å†™æ•°æ®åˆ°TX BUF 32å­—èŠ‚  TX_PLOAD_WIDTH
 514   1        RF24L01_SET_CE_HIGH( );     //å¯åŠ¨å‘é€
 515   1        while( 0 != RF24L01_GET_IRQ_STATUS( ))
 516   1        {
 517   2          drv_delay_ms( 1 );
 518   2          if( 500 == l_MsTimes++ )            //500msè¿˜æ²¡æœ‰å‘é€æˆåŠŸï¼Œé‡æ–°åˆå§‹åŒ–è®¾å¤‡
 519   2          {
 520   3            NRF24L01_Gpio_Init( );
 521   3            RF24L01_Init( );
 522   3            RF24L01_Set_Mode( MODE_TX );
 523   3            break;
 524   3          }
 525   2        }
 526   1        l_Status = NRF24L01_Read_Reg(STATUS);           //è¯»çŠ¶æ€å¯„å­˜å™¨
 527   1        NRF24L01_Write_Reg( STATUS, l_Status );           //æ¸…é™¤TX_DSæˆ–MAX_RTä¸­æ–­æ ‡å¿—
 528   1        
 529   1        if( l_Status & MAX_TX ) //è¾¾åˆ°æœ€å¤§é‡å‘æ¬¡æ•°
 530   1        {
 531   2          NRF24L01_Write_Reg( FLUSH_TX,0xff );  //æ¸…é™¤TX FIFOå¯„å­˜å™¨
 532   2          return MAX_TX; 
 533   2        }
 534   1        if( l_Status & TX_OK )  //å‘é€å®Œæˆ
 535   1        {
 536   2          return TX_OK;
 537   2        }
 538   1        
 539   1        return 0xFF;  //å…¶ä»–åŸå› å‘é€å¤±è´¥
 540   1      }
 541          
 542          /**
 543            * @brief :NRF24L01æ¥æ”¶æ•°æ®
 544            * @param :
 545            *     @rxbuf:æ¥æ”¶æ•°æ®å­˜æ”¾åœ°å€
 546            * @note  :æ— 
 547            * @retval:
 548            *     0:æ¥æ”¶å®Œæˆ
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 10  

 549            *     1:æ²¡æœ‰æ¥æ”¶åˆ°æ•°æ®
 550            */ 
 551          uint8_t NRF24L01_RxPacket( uint8_t *rxbuf )
 552          {
 553   1        uint8_t l_Status = 0, l_RxLength = 0, l_100MsTimes = 0;
 554   1        
 555   1        RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 556   1        drv_spi_read_write_byte( FLUSH_RX );
 557   1        RF24L01_SET_CS_HIGH( );
 558   1        
 559   1        while( 0 != RF24L01_GET_IRQ_STATUS( ))
 560   1        {
 561   2          drv_delay_ms( 100 );
 562   2          
 563   2          if( 30 == l_100MsTimes++ )    //3sæ²¡æ¥æ”¶è¿‡æ•°æ®ï¼Œé‡æ–°åˆå§‹åŒ–æ¨¡å—
 564   2          {
 565   3            NRF24L01_Gpio_Init( );
 566   3            RF24L01_Init( );
 567   3            RF24L01_Set_Mode( MODE_RX );
 568   3            break;
 569   3          }
 570   2        }
 571   1        
 572   1        l_Status = NRF24L01_Read_Reg( STATUS );   //è¯»çŠ¶æ€å¯„å­˜å™¨
 573   1        NRF24L01_Write_Reg( STATUS,l_Status );    //æ¸…ä¸­æ–­æ ‡å¿—
 574   1        if( l_Status & RX_OK) //æ¥æ”¶åˆ°æ•°æ®
 575   1        {
 576   2          l_RxLength = NRF24L01_Read_Reg( R_RX_PL_WID );    //è¯»å–æ¥æ”¶åˆ°çš„æ•°æ®ä¸ªæ•°
 577   2          NRF24L01_Read_Buf( RD_RX_PLOAD,rxbuf,l_RxLength );  //æ¥æ”¶åˆ°æ•°æ® 
 578   2          NRF24L01_Write_Reg( FLUSH_RX,0xff );        //æ¸…é™¤RX FIFO
 579   2          return l_RxLength; 
 580   2        } 
 581   1        
 582   1        return 0;       //æ²¡æœ‰æ”¶åˆ°æ•°æ®  
 583   1      }
 584          
 585          /**
 586            * @brief :NRF24L01åˆå§‹åŒ–
 587            * @param :æ— 
 588            * @note  :æ— 
 589            * @retval:æ— 
 590            */ 
 591          void NRF24L01_Gpio_Init( void )
 592          { 
 593   1        //å¼•è„šé…ç½® éƒ¨åˆ†51å•ç‰‡æœºä¸éœ€è¦ 
 594   1        //CE é…ç½®ä¸ºè¾“å‡º IRQé…ç½®ä¸ºè¾“å…¥
 595   1        RF24L01_CE_PxM0 |= IO_OUT_PUT_PP_M0 << RF24L01_CE_PIN_BIT;
 596   1        RF24L01_CE_PxM1 |= IO_OUT_PUT_PP_M1 << RF24L01_CE_PIN_BIT;
 597   1        RF24L01_CE = 1;
 598   1        
 599   1        RF24L01_IRQ_PxM0 |= IO_IN_PUT_ONLY_M0 << RF24L01_IRQ_PIN_BIT;
 600   1        RF24L01_IRQ_PxM1 |= IO_IN_PUT_ONLY_M1 << RF24L01_IRQ_PIN_BIT;
 601   1        
 602   1        RF24L01_CE = 0;       //ä½¿èƒ½è®¾å¤‡
 603   1        RF24L01_IRQ = 1;      //æ¸…ä¸­æ–­
 604   1        RF24L01_SET_CS_HIGH( );   //å–æ¶ˆSPIç‰‡é€‰
 605   1      }
 606          
 607           /**
 608            * @brief :RF24L01æ¨¡å—åˆå§‹åŒ–
 609            * @param :æ— 
 610            * @note  :æ— 
C51 COMPILER V9.60.0.0   DRV_RF24L01                                                       05/13/2022 21:57:19 PAGE 11  

 611            * @retval:æ— 
 612            */
 613          void RF24L01_Init( void )
 614          {
 615   1          uint8_t addr[5] = {INIT_ADDR};
 616   1      
 617   1          RF24L01_SET_CE_HIGH( );
 618   1          NRF24L01_Clear_IRQ_Flag( IRQ_ALL );
 619   1      #if DYNAMIC_PACKET == 1
 620   1      
 621   1          NRF24L01_Write_Reg( DYNPD, ( 1 << 0 ) );  //ä½¿èƒ½é€šé“1åŠ¨æ€æ•°æ®é•¿åº¦
 622   1          NRF24L01_Write_Reg( FEATRUE, 0x07 );
 623   1          NRF24L01_Read_Reg( DYNPD );
 624   1          NRF24L01_Read_Reg( FEATRUE );
 625   1        
 626   1      #elif DYNAMIC_PACKET == 0
                  
                  L01_WriteSingleReg( L01REG_RX_PW_P0, FIXED_PACKET_LEN );  //å›ºå®šæ•°æ®é•¿åº¦
                
              #endif  //DYNAMIC_PACKET
 631   1      
 632   1          NRF24L01_Write_Reg( CONFIG, /*( 1<<MASK_RX_DR ) |*/   //æ¥æ”¶ä¸­æ–­
 633   1                                            ( 1 << EN_CRC ) |     //ä½¿èƒ½CRC 1ä¸ªå­—èŠ‚
 634   1                                            ( 1 << PWR_UP ) );    //å¼€å¯è®¾å¤‡
 635   1          NRF24L01_Write_Reg( EN_AA, ( 1 << ENAA_P0 ) );      //é€šé“0è‡ªåŠ¨åº”ç­”
 636   1          NRF24L01_Write_Reg( EN_RXADDR, ( 1 << ERX_P0 ) );   //é€šé“0æ¥æ”¶
 637   1          NRF24L01_Write_Reg( SETUP_AW, AW_5BYTES );          //åœ°å€å®½åº¦ 5ä¸ªå­—èŠ‚
 638   1          NRF24L01_Write_Reg( SETUP_RETR, ARD_4000US |
 639   1                              ( REPEAT_CNT & 0x0F ) );          //é‡å¤ç­‰å¾…æ—¶é—´ 250us
 640   1          NRF24L01_Write_Reg( RF_CH, 60 );                  //åˆå§‹åŒ–é€šé“
 641   1          NRF24L01_Write_Reg( RF_SETUP, 0x26 );
 642   1      
 643   1          NRF24L01_Set_TxAddr( &addr[0], 5 );                      //è®¾ç½®TXåœ°å€
 644   1          NRF24L01_Set_RxAddr( 0, &addr[0], 5 );                   //è®¾ç½®RXåœ°å€
 645   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1426    ----
   CONSTANT SIZE    =     40    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =      3      70
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
