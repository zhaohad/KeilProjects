C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE DRV_RF24L01
OBJECT MODULE PLACED IN ..\output\drv_RF24L01.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE Source_File\drv_periph\src\drv_RF24L01.c COMPACT OPTIMIZE(8,SPEED) BROWS
                    -E INCDIR(.\Source_File\app\inc;.\Source_File\drv_mcu\inc;.\Source_File\drv_periph\inc) DEBUG OBJECTEXTEND PRINT(..\outpu
                    -t\drv_RF24L01.lst) TABS(2) OBJECT(..\output\drv_RF24L01.obj)

line level    source

   1          ï»¿/**
*** ERROR C100 IN LINE 1 OF Source_File\drv_periph\src\drv_RF24L01.c: unprintable character 0xEF skipped
*** ERROR C100 IN LINE 1 OF Source_File\drv_periph\src\drv_RF24L01.c: unprintable character 0xBB skipped
*** ERROR C100 IN LINE 1 OF Source_File\drv_periph\src\drv_RF24L01.c: unprintable character 0xBF skipped
   2            ******************************************************************************
   3            * @author  
   4            * @version 
   5            * @date    
   6            * @brief   
   7            ******************************************************************************
   8            * @attention
   9            *
  10            * 
  11            * 
  12            * 
  13            ******************************************************************************
  14            */
  15            
  16            
  17            
  18          #include "drv_RF24L01.h"
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_periph\inc\drv_RF24L01.h: unprintable character 0xEF skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_periph\inc\drv_RF24L01.h: unprintable character 0xBB skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_periph\inc\drv_RF24L01.h: unprintable character 0xBF skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_spi.h: unprintable character 0xEF skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_spi.h: unprintable character 0xBB skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_spi.h: unprintable character 0xBF skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xEF skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xBB skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xBF skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_uart.h: unprintable character 0xEF skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_uart.h: unprintable character 0xBB skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_uart.h: unprintable character 0xBF skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xEF skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xBB skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xBF skipped
  19          #include "drv_delay.h"
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_delay.h: unprintable character 0xEF skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_delay.h: unprintable character 0xBB skipped
*** ERROR C100 IN LINE 1 OF .\Source_File\drv_mcu\inc\drv_delay.h: unprintable character 0xBF skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xEF skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xBB skipped
*** ERROR C100 IN LINE 1 OF \hw\KeilProjects\µç×Ó×ÊÁÏ\G01-S\Demo³ÌĞò\demo_SI24R1\demo_SI24R1\Demo_nRF24L01_V3_0_ZeYao\De
             -mo_RF24L01_Stc89C52\Project_Rf24L01\Source_File\drv_mcu\inc\typedef.h: unprintable character 0xBF skipped
  20          
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 2   

  21          
  22          const char *g_ErrorString = "RF24L01 is not find !...";
  23          
  24          
  25          /**
  26            * @brief :NRF24L01è¯»å¯„å­˜å™¨
  27            * @param :
  28                     @Addr:å¯„å­˜å™¨åœ°å€
  29            * @note  :åœ°å€åœ¨è®¾å¤‡ä¸­æœ‰æ•ˆ
  30            * @retval:è¯»å–çš„æ•°æ®
  31            */
  32          uint8_t NRF24L01_Read_Reg( uint8_t RegAddr )
  33          {
  34   1          uint8_t btmp;
  35   1        
  36   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
  37   1        
  38   1          drv_spi_read_write_byte( NRF_READ_REG | RegAddr );  //è¯»å‘½ä»¤ åœ°å€
  39   1          btmp = drv_spi_read_write_byte( 0xFF );       //è¯»æ•°æ®
  40   1        
  41   1          RF24L01_SET_CS_HIGH( );     //å–æ¶ˆç‰‡é€‰
  42   1        
  43   1          return btmp;
  44   1      }
  45          
  46          /**
  47            * @brief :NRF24L01è¯»æŒ‡å®šé•¿åº¦çš„æ•°æ®
  48            * @param :
  49            *     @reg:åœ°å€
  50            *     @pBuf:æ•°æ®å­˜æ”¾åœ°å€
  51            *     @len:æ•°æ®é•¿åº¦
  52            * @note  :æ•°æ®é•¿åº¦ä¸è¶…è¿‡255ï¼Œåœ°å€åœ¨è®¾å¤‡ä¸­æœ‰æ•ˆ
  53            * @retval:è¯»å–çŠ¶æ€
  54            */
  55          void NRF24L01_Read_Buf( uint8_t RegAddr, uint8_t *pBuf, uint8_t len )
  56          {
  57   1          uint8_t btmp;
  58   1        
  59   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
  60   1        
  61   1          drv_spi_read_write_byte( NRF_READ_REG | RegAddr );  //è¯»å‘½ä»¤ åœ°å€
  62   1          for( btmp = 0; btmp < len; btmp ++ )
  63   1          {
  64   2              *( pBuf + btmp ) = drv_spi_read_write_byte( 0xFF ); //è¯»æ•°æ®
  65   2          }
  66   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
  67   1      }
  68          
  69          /**
  70            * @brief :NRF24L01å†™å¯„å­˜å™¨
  71            * @param :æ— 
  72            * @note  :åœ°å€åœ¨è®¾å¤‡ä¸­æœ‰æ•ˆ
  73            * @retval:è¯»å†™çŠ¶æ€
  74            */
  75          void NRF24L01_Write_Reg( uint8_t RegAddr, uint8_t Value )
  76          {
  77   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
  78   1        
  79   1          drv_spi_read_write_byte( NRF_WRITE_REG | RegAddr ); //å†™å‘½ä»¤ åœ°å€
  80   1          drv_spi_read_write_byte( Value );     //å†™æ•°æ®
  81   1        
  82   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 3   

  83   1      }
  84          
  85          /**
  86            * @brief :NRF24L01å†™æŒ‡å®šé•¿åº¦çš„æ•°æ®
  87            * @param :
  88            *     @reg:åœ°å€
  89            *     @pBuf:å†™å…¥çš„æ•°æ®åœ°å€
  90            *     @len:æ•°æ®é•¿åº¦
  91            * @note  :æ•°æ®é•¿åº¦ä¸è¶…è¿‡255ï¼Œåœ°å€åœ¨è®¾å¤‡ä¸­æœ‰æ•ˆ
  92            * @retval:å†™çŠ¶æ€
  93            */
  94          void NRF24L01_Write_Buf( uint8_t RegAddr, uint8_t *pBuf, uint8_t len )
  95          {
  96   1          uint8_t i;
  97   1        
  98   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
  99   1        
 100   1          drv_spi_read_write_byte( NRF_WRITE_REG | RegAddr ); //å†™å‘½ä»¤ åœ°å€
 101   1          for( i = 0; i < len; i ++ )
 102   1          {
 103   2              drv_spi_read_write_byte( *( pBuf + i ) );   //å†™æ•°æ®
 104   2          }
 105   1        
 106   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 107   1      }
 108          
 109          /**
 110            * @brief :æ¸…ç©ºTXç¼“å†²åŒº
 111            * @param :æ— 
 112            * @note  :æ— 
 113            * @retval:æ— 
 114            */
 115          void NRF24L01_Flush_Tx_Fifo ( void )
 116          {
 117   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 118   1        
 119   1          drv_spi_read_write_byte( FLUSH_TX );  //æ¸…TX FIFOå‘½ä»¤
 120   1        
 121   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 122   1      }
 123          
 124          /**
 125            * @brief :æ¸…ç©ºRXç¼“å†²åŒº
 126            * @param :æ— 
 127            * @note  :æ— 
 128            * @retval:æ— 
 129            */
 130          void NRF24L01_Flush_Rx_Fifo( void )
 131          {
 132   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 133   1        
 134   1          drv_spi_read_write_byte( FLUSH_RX );  //æ¸…RX FIFOå‘½ä»¤
 135   1        
 136   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 137   1      }
 138          
 139          /**
 140            * @brief :é‡æ–°ä½¿ç”¨ä¸Šä¸€åŒ…æ•°æ®
 141            * @param :æ— 
 142            * @note  :æ— 
 143            * @retval:æ— 
 144            */
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 4   

 145          void NRF24L01_Reuse_Tx_Payload( void )
 146          {
 147   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 148   1        
 149   1          drv_spi_read_write_byte( REUSE_TX_PL );   //é‡æ–°ä½¿ç”¨ä¸Šä¸€åŒ…å‘½ä»¤
 150   1        
 151   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 152   1      }
 153          
 154          /**
 155            * @brief :NRF24L01ç©ºæ“ä½œ
 156            * @param :æ— 
 157            * @note  :æ— 
 158            * @retval:æ— 
 159            */
 160          void NRF24L01_Nop( void )
 161          {
 162   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 163   1        
 164   1          drv_spi_read_write_byte( NOP );   //ç©ºæ“ä½œå‘½ä»¤
 165   1        
 166   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 167   1      }
 168          
 169          /**
 170            * @brief :NRF24L01è¯»çŠ¶æ€å¯„å­˜å™¨
 171            * @param :æ— 
 172            * @note  :æ— 
 173            * @retval:RF24L01çŠ¶æ€
 174            */
 175          uint8_t NRF24L01_Read_Status_Register( void )
 176          {
 177   1          uint8_t Status;
 178   1        
 179   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 180   1        
 181   1          Status = drv_spi_read_write_byte( NRF_READ_REG + STATUS );  //è¯»çŠ¶æ€å¯„å­˜å™¨
 182   1        
 183   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 184   1        
 185   1          return Status;
 186   1      }
 187          
 188          /**
 189            * @brief :NRF24L01æ¸…ä¸­æ–­
 190            * @param :
 191                     @IRQ_Source:ä¸­æ–­æº
 192            * @note  :æ— 
 193            * @retval:æ¸…é™¤åçŠ¶æ€å¯„å­˜å™¨çš„å€¼
 194            */
 195          uint8_t NRF24L01_Clear_IRQ_Flag( uint8_t IRQ_Source )
 196          {
 197   1          uint8_t btmp = 0;
 198   1      
 199   1          IRQ_Source &= ( 1 << RX_DR ) | ( 1 << TX_DS ) | ( 1 << MAX_RT );  //ä¸­æ–­æ ‡å¿—å¤„ç†
 200   1          btmp = NRF24L01_Read_Status_Register( );      //è¯»çŠ¶æ€å¯„å­˜å™¨
 201   1            
 202   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
 203   1          drv_spi_read_write_byte( NRF_WRITE_REG + STATUS );  //å†™çŠ¶æ€å¯„å­˜å™¨å‘½ä»¤
 204   1          drv_spi_read_write_byte( IRQ_Source | btmp );   //æ¸…ç›¸åº”ä¸­æ–­æ ‡å¿—
 205   1          RF24L01_SET_CS_HIGH( );     //å–æ¶ˆç‰‡é€‰
 206   1        
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 5   

 207   1          return ( NRF24L01_Read_Status_Register( ));     //è¿”å›çŠ¶æ€å¯„å­˜å™¨çŠ¶æ€
 208   1      }
 209          
 210          /**
 211            * @brief :è¯»RF24L01ä¸­æ–­çŠ¶æ€
 212            * @param :æ— 
 213            * @note  :æ— 
 214            * @retval:ä¸­æ–­çŠ¶æ€
 215            */
 216          uint8_t RF24L01_Read_IRQ_Status( void )
 217          {
 218   1          return ( NRF24L01_Read_Status_Register( ) & (( 1 << RX_DR ) | ( 1 << TX_DS ) | ( 1 << MAX_RT ))); //è¿
             -”å›ä¸­æ–­çŠ¶æ€
 219   1      }
 220           
 221           /**
 222            * @brief :è¯»FIFOä¸­æ•°æ®å®½åº¦
 223            * @param :æ— 
 224            * @note  :æ— 
 225            * @retval:æ•°æ®å®½åº¦
 226            */
 227          uint8_t NRF24L01_Read_Top_Fifo_Width( void )
 228          {
 229   1          uint8_t btmp;
 230   1        
 231   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 232   1        
 233   1          drv_spi_read_write_byte( R_RX_PL_WID ); //è¯»FIFOä¸­æ•°æ®å®½åº¦å‘½ä»¤
 234   1          btmp = drv_spi_read_write_byte( 0xFF ); //è¯»æ•°æ®
 235   1        
 236   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 237   1        
 238   1          return btmp;
 239   1      }
 240          
 241           /**
 242            * @brief :è¯»æ¥æ”¶åˆ°çš„æ•°æ®
 243            * @param :æ— 
 244            * @note  :æ— 
 245            * @retval:
 246                     @pRxBuf:æ•°æ®å­˜æ”¾åœ°å€é¦–åœ°å€
 247            */
 248          uint8_t NRF24L01_Read_Rx_Payload( uint8_t *pRxBuf )
 249          {
 250   1          uint8_t Width, PipeNum;
 251   1        
 252   1          PipeNum = ( NRF24L01_Read_Reg( STATUS ) >> 1 ) & 0x07;  //è¯»æ¥æ”¶çŠ¶æ€
 253   1          Width = NRF24L01_Read_Top_Fifo_Width( );    //è¯»æ¥æ”¶æ•°æ®ä¸ªæ•°
 254   1      
 255   1          RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 256   1          drv_spi_read_write_byte( RD_RX_PLOAD );     //è¯»æœ‰æ•ˆæ•°æ®å‘½ä»¤
 257   1        
 258   1          for( PipeNum = 0; PipeNum < Width; PipeNum ++ )
 259   1          {
 260   2              *( pRxBuf + PipeNum ) = drv_spi_read_write_byte( 0xFF );    //è¯»æ•°æ®
 261   2          }
 262   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 263   1          NRF24L01_Flush_Rx_Fifo( );  //æ¸…ç©ºRX FIFO
 264   1        
 265   1          return Width;
 266   1      }
 267          
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 6   

 268           /**
 269            * @brief :å‘é€æ•°æ®ï¼ˆå¸¦åº”ç­”ï¼‰
 270            * @param :
 271            *     @pTxBuf:å‘é€æ•°æ®åœ°å€
 272            *     @len:é•¿åº¦
 273            * @note  :ä¸€æ¬¡ä¸è¶…è¿‡32ä¸ªå­—èŠ‚
 274            * @retval:æ— 
 275            */
 276          void NRF24L01_Write_Tx_Payload_Ack( uint8_t *pTxBuf, uint8_t len )
 277          {
 278   1          uint8_t btmp;
 279   1          uint8_t length = ( len > 32 ) ? 32 : len;   //æ•°æ®é•¿è¾¾å¤§çº¦32 åˆ™åªå‘é€32ä¸ª
 280   1      
 281   1          NRF24L01_Flush_Tx_Fifo( );    //æ¸…TX FIFO
 282   1        
 283   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
 284   1          drv_spi_read_write_byte( WR_TX_PLOAD ); //å‘é€å‘½ä»¤
 285   1        
 286   1          for( btmp = 0; btmp < length; btmp ++ )
 287   1          {
 288   2              drv_spi_read_write_byte( *( pTxBuf + btmp ) );  //å‘é€æ•°æ®
 289   2          }
 290   1          RF24L01_SET_CS_HIGH( );     //å–æ¶ˆç‰‡é€‰
 291   1      }
 292          
 293           /**
 294            * @brief :å‘é€æ•°æ®ï¼ˆä¸å¸¦åº”ç­”ï¼‰
 295            * @param :
 296            *     @pTxBuf:å‘é€æ•°æ®åœ°å€
 297            *     @len:é•¿åº¦
 298            * @note  :ä¸€æ¬¡ä¸è¶…è¿‡32ä¸ªå­—èŠ‚
 299            * @retval:æ— 
 300            */
 301          void NRF24L01_Write_Tx_Payload_NoAck( uint8_t *pTxBuf, uint8_t len )
 302          {
 303   1          if( len > 32 || len == 0 )
 304   1          {
 305   2              return ;    //æ•°æ®é•¿åº¦å¤§äº32 æˆ–è€…ç­‰äº0 ä¸æ‰§è¡Œ
 306   2          }
 307   1        
 308   1          RF24L01_SET_CS_LOW( );  //ç‰‡é€‰
 309   1          drv_spi_read_write_byte( WR_TX_PLOAD_NACK );  //å‘é€å‘½ä»¤
 310   1          while( len-- )
 311   1          {
 312   2              drv_spi_read_write_byte( *pTxBuf );     //å‘é€æ•°æ®
 313   2          pTxBuf++;
 314   2          }
 315   1          RF24L01_SET_CS_HIGH( );   //å–æ¶ˆç‰‡é€‰
 316   1      }
 317          
 318           /**
 319            * @brief :åœ¨æ¥æ”¶æ¨¡å¼ä¸‹å‘TX FIFOå†™æ•°æ®(å¸¦ACK)
 320            * @param :
 321            *     @pData:æ•°æ®åœ°å€
 322            *     @len:é•¿åº¦
 323            * @note  :ä¸€æ¬¡ä¸è¶…è¿‡32ä¸ªå­—èŠ‚
 324            * @retval:æ— 
 325            */
 326          void NRF24L01_Write_Tx_Payload_InAck( uint8_t *pData, uint8_t len )
 327          {
 328   1          uint8_t btmp;
 329   1        
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 7   

 330   1        len = ( len > 32 ) ? 32 : len;    //æ•°æ®é•¿åº¦å¤§äº32ä¸ªåˆ™åªå†™32ä¸ªå­—èŠ‚
 331   1      
 332   1          RF24L01_SET_CS_LOW( );      //ç‰‡é€‰
 333   1          drv_spi_read_write_byte( W_ACK_PLOAD );   //å‘½ä»¤
 334   1          for( btmp = 0; btmp < len; btmp ++ )
 335   1          {
 336   2              drv_spi_read_write_byte( *( pData + btmp ) ); //å†™æ•°æ®
 337   2          }
 338   1          RF24L01_SET_CS_HIGH( );     //å–æ¶ˆç‰‡é€‰
 339   1      }
 340          
 341           /**
 342            * @brief :è®¾ç½®å‘é€åœ°å€
 343            * @param :
 344            *     @pAddr:åœ°å€å­˜æ”¾åœ°å€
 345            *     @len:é•¿åº¦
 346            * @note  :æ— 
 347            * @retval:æ— 
 348            */
 349          void NRF24L01_Set_TxAddr( uint8_t *pAddr, uint8_t len )
 350          {
 351   1        len = ( len > 5 ) ? 5 : len;          //åœ°å€ä¸èƒ½å¤§äº5ä¸ªå­—èŠ‚
 352   1          NRF24L01_Write_Buf( TX_ADDR, pAddr, len );  //å†™åœ°å€
 353   1      }
 354          
 355           /**
 356            * @brief :è®¾ç½®æ¥æ”¶é€šé“åœ°å€
 357            * @param :
 358            *     @PipeNum:é€šé“
 359            *     @pAddr:åœ°å€å­˜è‚¥ç€åœ°å€
 360            *     @Len:é•¿åº¦
 361            * @note  :é€šé“ä¸å¤§äº5 åœ°å€é•¿åº¦ä¸å¤§äº5ä¸ªå­—èŠ‚
 362            * @retval:æ— 
 363            */
 364          void NRF24L01_Set_RxAddr( uint8_t PipeNum, uint8_t *pAddr, uint8_t Len )
 365          {
 366   1          Len = ( Len > 5 ) ? 5 : Len;
 367   1          PipeNum = ( PipeNum > 5 ) ? 5 : PipeNum;    //é€šé“ä¸å¤§äº5 åœ°å€é•¿åº¦ä¸å¤§äº5ä¸ªå­—èŠ‚
 368   1      
 369   1          NRF24L01_Write_Buf( RX_ADDR_P0 + PipeNum, pAddr, Len ); //å†™å…¥åœ°å€
 370   1      }
 371          
 372           /**
 373            * @brief :è®¾ç½®é€šä¿¡é€Ÿåº¦
 374            * @param :
 375            *     @Speed:é€Ÿåº¦
 376            * @note  :æ— 
 377            * @retval:æ— 
 378            */
 379          void NRF24L01_Set_Speed( nRf24l01SpeedType Speed )
 380          {
 381   1        uint8_t btmp = 0;
 382   1        
 383   1        btmp = NRF24L01_Read_Reg( RF_SETUP );
 384   1        btmp &= ~( ( 1<<5 ) | ( 1<<3 ) );
 385   1        
 386   1        if( Speed == SPEED_250K )   //250K
 387   1        {
 388   2          btmp |= ( 1<<5 );
 389   2        }
 390   1        else if( Speed == SPEED_1M )   //1M
 391   1        {
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 8   

 392   2            btmp &= ~( ( 1<<5 ) | ( 1<<3 ) );
 393   2        }
 394   1        else if( Speed == SPEED_2M )   //2M
 395   1        {
 396   2          btmp |= ( 1<<3 );
 397   2        }
 398   1      
 399   1        NRF24L01_Write_Reg( RF_SETUP, btmp );
 400   1      }
 401          
 402           /**
 403            * @brief :è®¾ç½®åŠŸç‡
 404            * @param :
 405            *     @Speed:é€Ÿåº¦
 406            * @note  :æ— 
 407            * @retval:æ— 
 408            */
 409          void NRF24L01_Set_Power( nRf24l01PowerType Power )
 410          {
 411   1          uint8_t btmp;
 412   1        
 413   1        btmp = NRF24L01_Read_Reg( RF_SETUP ) & ~0x07;
 414   1          switch( Power )
 415   1          {
 416   2              case POWER_F18DBM:
 417   2                  btmp |= PWR_18DB;
 418   2                  break;
 419   2              case POWER_F12DBM:
 420   2                  btmp |= PWR_12DB;
 421   2                  break;
 422   2              case POWER_F6DBM:
 423   2                  btmp |= PWR_6DB;
 424   2                  break;
 425   2              case POWER_0DBM:
 426   2                  btmp |= PWR_0DB;
 427   2                  break;
 428   2              default:
 429   2                  break;
 430   2          }
 431   1          NRF24L01_Write_Reg( RF_SETUP, btmp );
 432   1      }
 433          
 434           /**
 435            * @brief :è®¾ç½®é¢‘ç‡
 436            * @param :
 437            *     @FreqPoint:é¢‘ç‡è®¾ç½®å‚æ•°
 438            * @note  :å€¼ä¸å¤§äº127
 439            * @retval:æ— 
 440            */
 441          void RF24LL01_Write_Hopping_Point( uint8_t FreqPoint )
 442          {
 443   1          NRF24L01_Write_Reg(  RF_CH, FreqPoint & 0x7F );
 444   1      }
 445          
 446          /**
 447            * @brief :NRF24L01æ£€æµ‹
 448            * @param :æ— 
 449            * @note  :æ— 
 450            * @retval:æ— 
 451            */ 
 452          void  NRF24L01_check( void )
 453          {
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 9   

 454   1        uint8_t i;
 455   1        uint8_t buf[5]={ 0XA5, 0XA5, 0XA5, 0XA5, 0XA5 };
 456   1        uint8_t read_buf[ 5 ] = { 0 };
 457   1         
 458   1        while( 1 )
 459   1        {
 460   2          NRF24L01_Write_Buf( TX_ADDR, buf, 5 );      //å†™å…¥5ä¸ªå­—èŠ‚çš„åœ°å€
 461   2          NRF24L01_Read_Buf( TX_ADDR, read_buf,5 );   //è¯»å‡ºå†™å…¥çš„åœ°å€  
 462   2          for( i = 0; i < 5; i++ )
 463   2          {
 464   3            if( buf[ i ] != read_buf[ i ] )
 465   3            {
 466   4              break;      //è¯»å‡ºçš„å€¼å’Œå†™å…¥çš„ç½®ä¸åŒ
 467   4            } 
 468   3          } 
 469   2          
 470   2          if( 5 == i )
 471   2          {
 472   3            break;        //è¯»å‡ºçš„å­—ç¬¦ä¸²ä¸å†™å…¥çš„å­—ç¬¦ä¸²ç›¸åŒï¼Œåˆ¤æ–­ä¸ºè®¾å¤‡å­˜åœ¨
 473   3          }
 474   2          else
 475   2          {
 476   3            drv_uart_tx_bytes( (uint8_t *)g_ErrorString, 26 );  //æ£€æµ‹ä¸åˆ°è®¾å¤‡ï¼Œè¾“å‡ºè­¦å‘Šä¿¡æ¯
 477   3          }
 478   2          drv_delay_ms( 500 );  //500MSæ£€æµ‹ä¸€æ¬¡
 479   2        }
 480   1      }
 481          
 482           /**
 483            * @brief :è®¾ç½®æ¨¡å¼
 484            * @param :
 485            *     @Mode:æ¨¡å¼å‘é€æ¨¡å¼æˆ–æ¥æ”¶æ¨¡å¼
 486            * @note  :æ— 
 487            * @retval:æ— 
 488            */
 489          void RF24L01_Set_Mode( nRf24l01ModeType Mode )
 490          {
 491   1          uint8_t controlreg = 0;
 492   1        controlreg = NRF24L01_Read_Reg( CONFIG );
 493   1        
 494   1          if( Mode == MODE_TX )       
 495   1        {
 496   2          controlreg &= ~( 1<< PRIM_RX );
 497   2        }
 498   1          else 
 499   1        {
 500   2          if( Mode == MODE_RX )  
 501   2          { 
 502   3            controlreg |= ( 1<< PRIM_RX ); 
 503   3          }
 504   2        }
 505   1      
 506   1          NRF24L01_Write_Reg( CONFIG, controlreg );
 507   1      }
 508          
 509          /**
 510            * @brief :NRF24L01å‘é€ä¸€æ¬¡æ•°æ®
 511            * @param :
 512            *     @txbuf:å¾…å‘é€æ•°æ®é¦–åœ°å€
 513            *     @Length:å‘é€æ•°æ®é•¿åº¦
 514            * @note  :æ— 
 515            * @retval:
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 10  

 516            *     MAX_TXï¼šè¾¾åˆ°æœ€å¤§é‡å‘æ¬¡æ•°
 517            *     TX_OKï¼šå‘é€å®Œæˆ
 518            *     0xFF:å…¶ä»–åŸå› 
 519            */ 
 520          uint8_t NRF24L01_TxPacket( uint8_t *txbuf, uint8_t Length )
 521          {
 522   1        uint8_t l_Status = 0;
 523   1        uint16_t l_MsTimes = 0;
 524   1        
 525   1        RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 526   1        drv_spi_read_write_byte( FLUSH_TX );
 527   1        RF24L01_SET_CS_HIGH( );
 528   1        
 529   1        RF24L01_SET_CE_LOW( );    
 530   1        NRF24L01_Write_Buf( WR_TX_PLOAD, txbuf, Length ); //å†™æ•°æ®åˆ°TX BUF 32å­—èŠ‚  TX_PLOAD_WIDTH
 531   1        RF24L01_SET_CE_HIGH( );     //å¯åŠ¨å‘é€
 532   1        while( 0 != RF24L01_GET_IRQ_STATUS( ))
 533   1        {
 534   2          drv_delay_ms( 1 );
 535   2          if( 500 == l_MsTimes++ )            //500msè¿˜æ²¡æœ‰å‘é€æˆåŠŸï¼Œé‡æ–°åˆå§‹åŒ–è®¾å¤‡
 536   2          {
 537   3            NRF24L01_Gpio_Init( );
 538   3            RF24L01_Init( );
 539   3            RF24L01_Set_Mode( MODE_TX );
 540   3            break;
 541   3          }
 542   2        }
 543   1        l_Status = NRF24L01_Read_Reg(STATUS);           //è¯»çŠ¶æ€å¯„å­˜å™¨
 544   1        NRF24L01_Write_Reg( STATUS, l_Status );           //æ¸…é™¤TX_DSæˆ–MAX_RTä¸­æ–­æ ‡å¿—
 545   1        
 546   1        if( l_Status & MAX_TX ) //è¾¾åˆ°æœ€å¤§é‡å‘æ¬¡æ•°
 547   1        {
 548   2          NRF24L01_Write_Reg( FLUSH_TX,0xff );  //æ¸…é™¤TX FIFOå¯„å­˜å™¨
 549   2          return MAX_TX; 
 550   2        }
 551   1        if( l_Status & TX_OK )  //å‘é€å®Œæˆ
 552   1        {
 553   2          return TX_OK;
 554   2        }
 555   1        
 556   1        return 0xFF;  //å…¶ä»–åŸå› å‘é€å¤±è´¥
 557   1      }
 558          
 559          /**
 560            * @brief :NRF24L01æ¥æ”¶æ•°æ®
 561            * @param :
 562            *     @rxbuf:æ¥æ”¶æ•°æ®å­˜æ”¾åœ°å€
 563            * @note  :æ— 
 564            * @retval:
 565            *     0:æ¥æ”¶å®Œæˆ
 566            *     1:æ²¡æœ‰æ¥æ”¶åˆ°æ•°æ®
 567            */ 
 568          uint8_t NRF24L01_RxPacket( uint8_t *rxbuf )
 569          {
 570   1        uint8_t l_Status = 0, l_RxLength = 0, l_100MsTimes = 0;
 571   1        
 572   1        RF24L01_SET_CS_LOW( );    //ç‰‡é€‰
 573   1        drv_spi_read_write_byte( FLUSH_RX );
 574   1        RF24L01_SET_CS_HIGH( );
 575   1        
 576   1        while( 0 != RF24L01_GET_IRQ_STATUS( ))
 577   1        {
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 11  

 578   2          drv_delay_ms( 100 );
 579   2          
 580   2          if( 30 == l_100MsTimes++ )    //3sæ²¡æ¥æ”¶è¿‡æ•°æ®ï¼Œé‡æ–°åˆå§‹åŒ–æ¨¡å—
 581   2          {
 582   3            NRF24L01_Gpio_Init( );
 583   3            RF24L01_Init( );
 584   3            RF24L01_Set_Mode( MODE_RX );
 585   3            break;
 586   3          }
 587   2        }
 588   1        
 589   1        l_Status = NRF24L01_Read_Reg( STATUS );   //è¯»çŠ¶æ€å¯„å­˜å™¨
 590   1        NRF24L01_Write_Reg( STATUS,l_Status );    //æ¸…ä¸­æ–­æ ‡å¿—
 591   1        if( l_Status & RX_OK) //æ¥æ”¶åˆ°æ•°æ®
 592   1        {
 593   2          l_RxLength = NRF24L01_Read_Reg( R_RX_PL_WID );    //è¯»å–æ¥æ”¶åˆ°çš„æ•°æ®ä¸ªæ•°
 594   2          NRF24L01_Read_Buf( RD_RX_PLOAD,rxbuf,l_RxLength );  //æ¥æ”¶åˆ°æ•°æ® 
 595   2          NRF24L01_Write_Reg( FLUSH_RX,0xff );        //æ¸…é™¤RX FIFO
 596   2          return l_RxLength; 
 597   2        } 
 598   1        
 599   1        return 0;       //æ²¡æœ‰æ”¶åˆ°æ•°æ®  
 600   1      }
 601          
 602          /**
 603            * @brief :NRF24L01åˆå§‹åŒ–
 604            * @param :æ— 
 605            * @note  :æ— 
 606            * @retval:æ— 
 607            */ 
 608          void NRF24L01_Gpio_Init( void )
 609          { 
 610   1        //å¼•è„šé…ç½® éƒ¨åˆ†51å•ç‰‡æœºä¸éœ€è¦ 
 611   1        //CE é…ç½®ä¸ºè¾“å‡º IRQé…ç½®ä¸ºè¾“å…¥
 612   1        RF24L01_CE_PxM0 |= IO_OUT_PUT_PP_M0 << RF24L01_CE_PIN_BIT;
 613   1        RF24L01_CE_PxM1 |= IO_OUT_PUT_PP_M1 << RF24L01_CE_PIN_BIT;
 614   1        RF24L01_CE = 1;
 615   1        
 616   1        RF24L01_IRQ_PxM0 |= IO_IN_PUT_ONLY_M0 << RF24L01_IRQ_PIN_BIT;
 617   1        RF24L01_IRQ_PxM1 |= IO_IN_PUT_ONLY_M1 << RF24L01_IRQ_PIN_BIT;
 618   1        
 619   1        RF24L01_CE = 0;       //ä½¿èƒ½è®¾å¤‡
 620   1        RF24L01_IRQ = 1;      //æ¸…ä¸­æ–­
 621   1        RF24L01_SET_CS_HIGH( );   //å–æ¶ˆSPIç‰‡é€‰
 622   1      }
 623          
 624           /**
 625            * @brief :RF24L01æ¨¡å—åˆå§‹åŒ–
 626            * @param :æ— 
 627            * @note  :æ— 
 628            * @retval:æ— 
 629            */
 630          void RF24L01_Init( void )
 631          {
 632   1          uint8_t addr[5] = {INIT_ADDR};
 633   1      
 634   1          RF24L01_SET_CE_HIGH( );
 635   1          NRF24L01_Clear_IRQ_Flag( IRQ_ALL );
 636   1      #if DYNAMIC_PACKET == 1
 637   1      
 638   1          NRF24L01_Write_Reg( DYNPD, ( 1 << 0 ) );  //ä½¿èƒ½é€šé“1åŠ¨æ€æ•°æ®é•¿åº¦
 639   1          NRF24L01_Write_Reg( FEATRUE, 0x07 );
C51 COMPILER V9.60.7.0   DRV_RF24L01                                                       05/07/2023 23:34:00 PAGE 12  

 640   1          NRF24L01_Read_Reg( DYNPD );
 641   1          NRF24L01_Read_Reg( FEATRUE );
 642   1        
 643   1      #elif DYNAMIC_PACKET == 0
                  
                  L01_WriteSingleReg( L01REG_RX_PW_P0, FIXED_PACKET_LEN );  //å›ºå®šæ•°æ®é•¿åº¦
                
              #endif  //DYNAMIC_PACKET
 648   1      
 649   1          NRF24L01_Write_Reg( CONFIG, /*( 1<<MASK_RX_DR ) |*/   //æ¥æ”¶ä¸­æ–­
 650   1                                            ( 1 << EN_CRC ) |     //ä½¿èƒ½CRC 1ä¸ªå­—èŠ‚
 651   1                                            ( 1 << PWR_UP ) );    //å¼€å¯è®¾å¤‡
 652   1          NRF24L01_Write_Reg( EN_AA, ( 1 << ENAA_P0 ) );      //é€šé“0è‡ªåŠ¨åº”ç­”
 653   1          NRF24L01_Write_Reg( EN_RXADDR, ( 1 << ERX_P0 ) );   //é€šé“0æ¥æ”¶
 654   1          NRF24L01_Write_Reg( SETUP_AW, AW_5BYTES );          //åœ°å€å®½åº¦ 5ä¸ªå­—èŠ‚
 655   1          NRF24L01_Write_Reg( SETUP_RETR, ARD_4000US |
 656   1                              ( REPEAT_CNT & 0x0F ) );          //é‡å¤ç­‰å¾…æ—¶é—´ 250us
 657   1          NRF24L01_Write_Reg( RF_CH, 60 );                  //åˆå§‹åŒ–é€šé“
 658   1          NRF24L01_Write_Reg( RF_SETUP, 0x26 );
 659   1      
 660   1          NRF24L01_Set_TxAddr( &addr[0], 5 );                      //è®¾ç½®TXåœ°å€
 661   1          NRF24L01_Set_RxAddr( 0, &addr[0], 5 );                   //è®¾ç½®RXåœ°å€
 662   1      }

C51 COMPILATION COMPLETE.  0 WARNING(S),  24 ERROR(S)
